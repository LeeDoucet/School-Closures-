---
title: "School After Recess: Exploring Rural School Closures (2012-2020)"
author: "Lee Doucet"
date:  "April 9th 2021"
output:
  pdf_document: default

bibliography: references.bib  
---

```{r include = FALSE}
#Load Packages
#install.packages("readxl")
#installed.packages("openxl")
library(openxlsx)
library(tidyverse)
library(readxl)



mydf <- read_excel("SchoolData.xlsx") # Loading Data 
#mydf <- read_excel("SchoolData2.xlsx") # Loading Data 
```
# Abstract 

```{r}

```

# Introduction 

  The topic of preventing school closures is one of those rare bi-partisan issues 
that can bring people together from both sides of the political spectrum in working 
towards a common goal. Despite having a common goal, school closures have morphed 
into battle grounds between parents, school boards, and the government that represents
them. This is especially true in rural communities where previous changes in the 
per-pupil funding formula and trends in provincial demographics have been lowering 
school enrollment numbers. Declining enrollment is problematic as the government prefers
approximately 500-800 students per school and traditionally rural schools have much 
less, around the range of 100-150 students per school. It would come to no surprise 
that the government is looking at 600 closures with 500 of those being from rural 
communities. A wave of closures of that magnitude threatens to tear the heart out 
of many rural communities. Schools are much larger than the sum of their parts in 
rural areas, they act as community hubs and are intrinsic to their economic prosperity.
Once a rural area loses their local due to low enrollment, it causes a snowball effect 
where families are less likely to move there, meaning even lower enrollment in the 
next school where the students are now being bused towards which threatens their 
funding. 

Attempting to determine the appropriate threat level to rural communities has been 
made difficult by the lack of public data that is made available. Both the Ministry
of Education and local school boards do not publish the schools that are under review 
or provide legacy lists of all schools that have been closed and what has replaced 
them. Even more challenging is determining the reason for closure. Schools can be 
closed for different reasons, they may have been dilapidated and a new one was constructed 
to replace it. Or perhaps two schools were suffering from low enrollment and a new 
one was built to replace both of them. To better understand what is transpiring with 
rural school closures, research has been conducted into what factors can be attributed
to a school closure. It is the hope of this research that it can support parents 
dealing with on-going school closures and help academics working in this domain. 


```{r}

### Cleaning Data - Checking the Data ###

sapply(mydf, function(x) sum(is.na(x))) #Checking for NAs, 1 in School Number & Status and 17 in Enrolment
mydf[is.na(mydf$Enrolment),] # lists NA values 
mydf[is.na(mydf$Status),] # Status and Enrolment share the same NAs

unique(mydf[c("School Level")])
unique(mydf[c("School Type")]) # School Type + Catholic/Roman Catholic + English
unique(mydf[c("School Language")]) # School Language + Public is listed 
unique(mydf[c("Status")]) # 1 NA column

```

```{r}
### Replacing NAs in Enrolment ###

mydf$Enrolment<-gsub("<","",as.character(mydf$Enrolment)) #Changes <10 to 10
mydf$Enrolment <- as.numeric(mydf$Enrolment) 

which(grepl(726800, mydf$`School Number`)) #Find data frame row of school ID
mydf[4858, 8] = 10 # É Élém C Laurier-Carrière - NA to 10 

which(grepl(689505, mydf$`School Number`)) 
mydf[4860, 8] = 10 # É Bishop Belleau - French Language Unit - NA to 10 

which(grepl(733490, mydf$`School Number`)) 
mydf[4902, 8] = 10 # Msgr Fraser Orientation Centre - NA to 10 

which(grepl(557617, mydf$`School Number`)) 
mydf[4907, 8] = 10 # Metropolitan Toronto School for the - NA to 10 

which(grepl(924598, mydf$`School Number`)) 
mydf[5210, 8] = 10 # M W Moore SS - NA to 10 

which(grepl(201057, mydf$`School Number`)) 
mydf[4980, 8] = 10 # Foleyet PS - NA to 10 

which(grepl(201057, mydf$`School Number`)) 
mydf[4980, 8] = 10 # Foleyet PS - NA to 10 

which(grepl(781185, mydf$`School Number`)) 
mydf[5006, 8] = 10 # St Casimir's Catholic S - NA to 10 

which(grepl(695602, mydf$`School Number`))  
mydf[5019, 8] = 10 # St Joseph S - NA to 10 

which(grepl(311483, mydf$`School Number`)) 
mydf[5084, 8] = 10 # MPS French Language Unit - NA to 10 

which(grepl(852549, mydf$`School Number`)) 
mydf[5100, 8] = 10 # MPS 	Msgr Fraser College (OL Lourdes Campus) - NA to 10 

which(grepl(447212, mydf$`School Number`)) 
mydf[5156, 8] = 10 # Peel Alternative - West Elementary - NA to 10

which(grepl(86698, mydf$`School Number`)) 
mydf[5168, 8] = 10 # 	Jean Augustine Girls' Leadership Academy - NA to 10

which(grepl(924598, mydf$`School Number`)) 
mydf[4930, 8] = 10 # 	M W Moore SS - NA to 10

which(grepl(706078, mydf$`School Number`)) 
mydf[5218, 8] = 10 # 	Francis Libermann Catholic Elementary CS - NA to 10

which(grepl(26336, mydf$`School Number`)) 
mydf[5230, 8] = 10 # 	M W Moore PS - NA to 10

which(grepl(26336, mydf$`School Number`)) 
mydf[5230, 8] = 10 # 	M W Moore PS - NA to 10

which(grepl(741782, mydf$`School Number`)) 
mydf[5234, 8] = 10 # 	St. James Intermediate - NA to 10


``` 

```{r}

### Transforming Data ###

n_occur <- data.frame(table(mydf$`School Number`)) #Data Frame with a list of id's and the number of times they occurred
n_occur[n_occur$Freq > 1,] #tells me which id's occurred more than once
mydf[mydf$`School Number` %in% n_occur$Var1[n_occur$Freq > 1],] #Returns the records with more than one occurrence.

which(grepl(733490, mydf$`School Number`)) #Looking for Duplicate Entry 
which(grepl(924598, mydf$`School Number`))
mydf <- mydf[-c(4902,4930,5244),] #Removing Duplicate Entries + Data Entry Error

### Note, apparently, and frustratingly so, School Boards have reused School IDs ###
```

```{r}
# Fixing Schools with wrong language 

mydf[mydf$`School Type` %in% c("English"), ]

mydf$'School Type' <-gsub("Roman Catholic","Catholic", as.character(mydf$`School Type`)) # shorten Roman Catholic

which(grepl(619396, mydf$`School Number`))
mydf$`School Type`[5225] <- 'Public'
mydf$`School Language`[5225] <- 'English'

which(grepl(894621, mydf$`School Number`))
mydf$`School Type`[5226] <- 'Public'
mydf$`School Language`[5226] <- 'English'

which(grepl(279960, mydf$`School Number`))
mydf$`School Type`[5227] <- 'Public'
mydf$`School Language`[5227] <- 'English'

which(grepl(26336, mydf$`School Number`))
mydf$`School Type`[5228] <- 'Public'
mydf$`School Language`[5228] <- 'English'

which(grepl(531073, mydf$`School Number`))
mydf$`School Type`[5229] <- 'Public'
mydf$`School Language`[5229] <- 'English'

which(grepl(73130, mydf$`School Number`))
mydf$`School Type`[5230] <- 'Public'
mydf$`School Language`[5230] <- 'English'

which(grepl(936286, mydf$`School Number`))
mydf$`School Type`[5231] <- 'Public'
mydf$`School Language`[5231] <- 'English'

which(grepl(741782, mydf$`School Number`))
mydf$`School Type`[5232] <- 'Catholic'
mydf$`School Language`[5232] <- 'English'

which(grepl(28304, mydf$`School Number`))
mydf$`School Type`[5233] <- 'Public'
mydf$`School Language`[5233] <- 'English'

which(grepl(846929, mydf$`School Number`))
mydf$`School Type`[5234] <- 'Catholic'
mydf$`School Language`[5234] <- 'English'

which(grepl(919977, mydf$`School Number`))
mydf$`School Type`[5235] <- 'Public'
mydf$`School Language`[5235] <- 'English'

which(grepl(748504, mydf$`School Number`))
mydf$`School Type`[5236] <- 'Catholic'
mydf$`School Language`[5236] <- 'English'

which(grepl(945587, mydf$`School Number`))
mydf$`School Type`[5237] <- 'Public'
mydf$`School Language`[5237] <- 'English'

which(grepl(117986, mydf$`School Number`))
mydf$`School Type`[5238] <- 'Public'
mydf$`School Language`[5238] <- 'English'

which(grepl(941883, mydf$`School Number`))
mydf$`School Type`[5239] <- 'Public'
mydf$`School Language`[5239] <- 'English'

which(grepl(911607, mydf$`School Number`))
mydf$`School Type`[5240] <- 'Public'
mydf$`School Language`[5240] <- 'English'

which(grepl(903850, mydf$`School Number`))
mydf$`School Type`[5241] <- 'Public'
mydf$`School Language`[5241] <- 'English'

```

```{R}
### Last Pre-Processing ###

which(grepl(439738, mydf$`School Number`))

mydf <- mydf[-c(2720),] # Deleting Protestant Separate
```


# Data 

See https://github.com/LeeDoucet/School-Closures- for Data 

My current plan is to run a logistic regression on the binary
dependent variable of status (closed/open). 

```{r} 
### Change Variable Types ###

str(mydf)



mydf$`Board Name` <- as.factor(mydf$`Board Name`)
mydf$`School Level` <- as.factor(mydf$`School Level`)
mydf$`School Type` <- as.factor(mydf$`School Type`)
mydf$`School Language` <- as.factor(mydf$`School Language`)
mydf$`School Type` <- as.factor(mydf$`School Type`)
mydf$Enrolment <- as.numeric(mydf$Enrolment)
mydf$Status <- as.factor(mydf$Status)
mydf$Region <- as.factor(mydf$Region)

``` 

```{r include = FALSE}

### Create Sample of Open Schools Without Replacement ###

opendf <- mydf[1:4842,] #Selects Rows that have closed for Status 
closedf <- mydf[4843:5240,] #Selects Rows that have open for Status 

set.seed(1)
openSample <- sample(1:nrow(opendf), 398) #Random Sample Without Replacement from schools that are open
openDfSample <- opendf[openSample, ]

sampleSize <- rbind(closedf, openDfSample) #merge the two data frames together 

```

```{r}

mydf %>% count(Status)

```



```{R}
### LogisticRegression ###

logRegression1 <- glm(Status ~ `School Type` + `School Language`+ `School Level` + Enrolment, data =sampleSize, family = binomial)
summary(logRegression1)

logRegression2 <- glm(Status ~ `School Type` + `School Language`+ `Board Name` + `School Level` + Enrolment, data =sampleSize, family = binomial)
summary(logRegression)

logRegression3 <- glm(Status ~ `School Type` + `School Language`+ `Region` + `School Level` + Enrolment, data =sampleSize, family = binomial)
summary(logRegression3)

logRegression4 <- glm(Status ~ Region + Enrolment, data =sampleSize, family = binomial)
summary(logRegression4)



```

# Discussion 

```{r}

```

# Appendix

```{r}
test <- glm(Status ~ `School Type` + `School Language` + `School Level`, data = mydf, family = binomial)
summary(test)

write.xlsx(closedf, 'Closed_DF.xlsx')
xtabs(~Status + `School Type`, data=mydf)
```
# References
